{
  "feature": "전화번호 중복 체크 - 백엔드",
  "description": "SMS 발송 API에서 전화번호 중복 체크 후 409 반환",
  "approach": "기존 /api/auth/sms/send 엔드포인트에 중복 체크 로직 통합",

  "api_spec": {
    "endpoint": "POST /api/auth/sms/send",
    "method": "POST",
    "request": {
      "content_type": "application/json",
      "body": {
        "phone": "string (01012345678 형식, 하이픈 없음)"
      }
    },
    "responses": {
      "200_success": {
        "status": 200,
        "body": {
          "success": true,
          "data": {
            "sessionId": "string (인증 세션 ID)"
          },
          "message": "인증번호가 전송되었습니다."
        }
      },
      "409_duplicate": {
        "status": 409,
        "body": {
          "success": false,
          "error": "DUPLICATE_PHONE",
          "message": "이미 가입된 전화번호입니다."
        }
      },
      "400_invalid": {
        "status": 400,
        "body": {
          "success": false,
          "error": "INVALID_PHONE",
          "message": "올바른 전화번호 형식이 아닙니다."
        }
      },
      "429_rate_limit": {
        "status": 429,
        "body": {
          "success": false,
          "error": "RATE_LIMITED",
          "message": "요청이 너무 많습니다. 잠시 후 다시 시도해주세요."
        }
      }
    }
  },

  "implementation": {
    "language": "TypeScript/Node.js (Supabase Edge Function 또는 Express)",
    "pseudo_code": [
      "export async function sendSmsHandler(req, res) {",
      "    const { phone } = req.body;",
      "",
      "    // 1. 전화번호 형식 검증",
      "    const phoneRegex = /^01([0|1|6|7|8|9])([0-9]{3,4})([0-9]{4})$/;",
      "    if (!phone || !phoneRegex.test(phone)) {",
      "        return res.status(400).json({",
      "            success: false,",
      "            error: 'INVALID_PHONE',",
      "            message: '올바른 전화번호 형식이 아닙니다.'",
      "        });",
      "    }",
      "",
      "    // 2. 전화번호 중복 체크 (핵심 추가 로직)",
      "    const existingUser = await db.users.findOne({",
      "        where: { phoneNumber: phone }",
      "    });",
      "",
      "    if (existingUser) {",
      "        return res.status(409).json({",
      "            success: false,",
      "            error: 'DUPLICATE_PHONE',",
      "            message: '이미 가입된 전화번호입니다.'",
      "        });",
      "    }",
      "",
      "    // 3. Rate Limiting 체크",
      "    const recentAttempts = await checkRateLimit(phone);",
      "    if (recentAttempts > 5) {",
      "        return res.status(429).json({",
      "            success: false,",
      "            error: 'RATE_LIMITED',",
      "            message: '요청이 너무 많습니다. 잠시 후 다시 시도해주세요.'",
      "        });",
      "    }",
      "",
      "    // 4. SMS 발송",
      "    try {",
      "        const verificationCode = generateCode(); // 4자리 랜덤",
      "        const sessionId = generateSessionId();",
      "",
      "        // 세션 저장 (Redis 또는 DB)",
      "        await saveVerificationSession({",
      "            sessionId,",
      "            phone,",
      "            code: verificationCode,",
      "            expiresAt: Date.now() + 3 * 60 * 1000 // 3분",
      "        });",
      "",
      "        // SMS 발송 (실제 SMS 서비스 연동)",
      "        await smsService.send(phone, `인증번호: ${verificationCode}`);",
      "",
      "        return res.status(200).json({",
      "            success: true,",
      "            data: { sessionId },",
      "            message: '인증번호가 전송되었습니다.'",
      "        });",
      "    } catch (error) {",
      "        console.error('SMS 발송 실패:', error);",
      "        return res.status(500).json({",
      "            success: false,",
      "            error: 'SMS_SEND_FAILED',",
      "            message: '인증번호 발송에 실패했습니다.'",
      "        });",
      "    }",
      "}"
    ],

    "supabase_edge_function": {
      "file": "supabase/functions/api/auth/sms/send.ts",
      "code": [
        "import { createClient } from '@supabase/supabase-js';",
        "",
        "Deno.serve(async (req) => {",
        "    const { phone } = await req.json();",
        "",
        "    const supabase = createClient(",
        "        Deno.env.get('SUPABASE_URL')!,",
        "        Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!",
        "    );",
        "",
        "    // 중복 체크",
        "    const { data: existingUser } = await supabase",
        "        .from('users')",
        "        .select('id')",
        "        .eq('phone_number', phone)",
        "        .single();",
        "",
        "    if (existingUser) {",
        "        return new Response(",
        "            JSON.stringify({",
        "                success: false,",
        "                error: 'DUPLICATE_PHONE',",
        "                message: '이미 가입된 전화번호입니다.'",
        "            }),",
        "            { status: 409, headers: { 'Content-Type': 'application/json' } }",
        "        );",
        "    }",
        "",
        "    // ... SMS 발송 로직",
        "});"
      ]
    }
  },

  "database_query": {
    "table": "users",
    "column": "phone_number",
    "index_recommendation": "phone_number 컬럼에 UNIQUE INDEX 추가 권장",
    "sql": "CREATE UNIQUE INDEX idx_users_phone ON users(phone_number) WHERE phone_number IS NOT NULL;"
  },

  "security_considerations": [
    {
      "concern": "전화번호 수집 공격",
      "mitigation": "Rate Limiting (IP당 분당 10회, 전화번호당 시간당 5회)"
    },
    {
      "concern": "정보 노출",
      "mitigation": "에러 메시지 일반화 가능 (보안 수준에 따라 '인증에 실패했습니다'로 통일)"
    },
    {
      "concern": "Timing Attack",
      "mitigation": "중복/비중복 응답 시간 일관성 유지"
    }
  ],

  "testing": [
    {
      "case": "신규 전화번호",
      "input": { "phone": "01012345678" },
      "expected_status": 200,
      "expected_body": { "success": true, "data": { "sessionId": "..." } }
    },
    {
      "case": "중복 전화번호",
      "input": { "phone": "01098765432" },
      "precondition": "해당 번호로 이미 가입된 사용자 존재",
      "expected_status": 409,
      "expected_body": { "success": false, "error": "DUPLICATE_PHONE" }
    },
    {
      "case": "잘못된 형식",
      "input": { "phone": "1234" },
      "expected_status": 400,
      "expected_body": { "success": false, "error": "INVALID_PHONE" }
    }
  ],

  "deployment_checklist": [
    "1. users 테이블에 phone_number 컬럼 존재 확인",
    "2. phone_number UNIQUE INDEX 생성",
    "3. SMS 발송 API 수정 배포",
    "4. Rate Limiting 설정 확인",
    "5. 프론트엔드 409 처리 코드 배포"
  ]
}
